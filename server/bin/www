#!/usr/bin/env node

var app = require('../app');
var http = require('http');
var dotenv = require('dotenv');
var mongoose = require('mongoose');
var mqttHandler = require('../controller/BrokerController');

dotenv.config({path: '.env'});


mongoose.connect(process.env.MONGODB_URI, {
    useNewUrlParser: true, 
}).then(() => {
    console.log('Connected to MongoDB');
}).catch((err) => {
    console.error('Error connecting to MongoDB\n');
    console.error(err);
});

const mqttClient = new mqttHandler(
    process.env.MQTT_HOST,
    process.env.MQTT_USER,
    process.env.MQTT_PASSWORD
);

// Suscribirse a todos los tópicos usando el carácter comodín #
mqttClient.subscribe('#', (err) => {
    if (!err) {
      console.log("Subscribed to all topics")
    } else {
      console.error("Error subscribing to topics: ", err);
    }
});

var httpServer = http.createServer(app);

httpServer.listen(process.env.SERVER_PORT, function (err) {
    if (err) {
        console.error('Failure to launch server');
        return;
    }
    console.log(`Listening on port ${process.env.SERVER_PORT}`);
});